{% extends 'admin_panel/base.html' %}

{% block title %}Adaptive Learning Control - Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-cogs text-warning"></i>
            Adaptive Learning Control Panel
        </h2>
        <button class="btn btn-success" onclick="refreshData()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <!-- Control Panel -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-play-circle me-2"></i>
                        Start Adaptive Retraining
                    </h5>
                </div>
                <div class="card-body">
                    <form id="retrainingForm" method="post" action="{% url 'admin:core_retraininglog_add' %}">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Job Name</label>
                                <input type="text" class="form-control" 
                                       placeholder="e.g., Monthly Retraining" 
                                       value="Manual Retraining - {{ current_date }}" 
                                       name="name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Scope</label>
                                <select class="form-select" id="scopeSelect" name="scope">
                                    <option value="needing">Only meters needing retraining</option>
                                    <option value="all">All meters with models</option>
                                    <option value="selected">Selected meters only</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3" id="meterSelection" style="display: none;">
                            <div class="col-12">
                                <label class="form-label">Select Meters</label>
                                <div style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; padding: 10px;">
                                    {% for meter in meters_needing %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="selected_meters" value="{{ meter.meter_id }}">
                                        <label class="form-check-label">
                                            {{ meter.meter_id }} (Score: {{ meter.score }})
                                        </label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Training Window</label>
                                <select class="form-select" name="window_days">
                                    <option value="30" selected>30 days (default)</option>
                                    <option value="60">60 days</option>
                                    <option value="90">90 days</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Validation Days</label>
                                <select class="form-select" name="validation_days">
                                    <option value="7" selected>7 days (default)</option>
                                    <option value="14">14 days</option>
                                    <option value="30">30 days</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Improvement Threshold</label>
                                <select class="form-select" name="improvement_threshold">
                                    <option value="5" selected>5% (default)</option>
                                    <option value="10">10%</option>
                                    <option value="2">2%</option>
                                </select>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note:</strong> Retraining uses the last N days of available data. 
                            Models are replaced only if F1-score improves by the threshold percentage.
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-secondary" onclick="showPreview()">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <button type="submit" class="btn btn-warning" onclick="startRetraining(event)">
                                <i class="fas fa-play"></i> Start Retraining
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-heartbeat me-2"></i>
                        System Health
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted">Model Coverage</small>
                        <div class="progress" style="height: 20px;">
                            {% widthratio system_health.meters_with_models system_health.total_meters 100 as coverage_percent %}
                            <div class="progress-bar bg-success" 
                                 style="width: {{ coverage_percent }}%">
                                {{ coverage_percent }}%
                            </div>
                        </div>
                        <small class="text-muted">
                            {{ system_health.meters_with_models }} of {{ system_health.total_meters }} meters
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Average Model Age</small>
                        <div class="progress" style="height: 20px;">
                            {% with age_days=system_health.average_model_age_days %}
                            {% with age_percent=age_days|divisibleby:365|yesno:"100,0" %}
                            <div class="progress-bar bg-info" 
                                 style="width: {{ age_percent }}%">
                                {{ age_days }} days
                            </div>
                            {% endwith %}
                            {% endwith %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">Retraining Success Rate</small>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-warning" 
                                 style="width: {{ system_health.success_rate }}%">
                                {{ system_health.success_rate|floatformat:0 }}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle"></i> Ready</h6>
                            <small>System is ready for adaptive retraining.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Meters Needing Retraining -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Meters Needing Retraining ({{ meters_needing|length }})
                <span class="badge bg-danger ms-2">Priority</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Meter ID</th>
                            <th>Priority Score</th>
                            <th>Reasons</th>
                            <th>Days Since Retraining</th>
                            <th>Recent Anomalies</th>
                            <th>Avg Confidence</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for meter in meters_needing %}
                        <tr>
                            <td>
                                <a href="{% url 'meter_detail' meter.meter_id %}">
                                    {{ meter.meter_id }}
                                </a>
                            </td>
                            <td>
                                <span class="badge {% if meter.score >= 5 %}bg-danger{% elif meter.score >= 3 %}bg-warning{% else %}bg-info{% endif %}">
                                    {{ meter.score }}/6
                                </span>
                            </td>
                            <td>
                                <small>
                                    {% for reason in meter.reasons %}
                                    <span class="badge bg-secondary mb-1">{{ reason }}</span>
                                    {% endfor %}
                                </small>
                            </td>
                            <td>{{ meter.days_since_retraining }}</td>
                            <td>{{ meter.recent_anomalies }}</td>
                            <td>{{ meter.avg_confidence|floatformat:2 }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-warning" 
                                        onclick="retrainSingleMeter('{{ meter.meter_id }}')">
                                    <i class="fas fa-cog"></i> Retrain
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <i class="fas fa-check-circle me-2"></i>
                                All meters are up-to-date!
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Recent Retraining Logs -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-history me-2"></i>
                Recent Retraining Logs
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Job Name</th>
                            <th>Started</th>
                            <th>Status</th>
                            <th>Meters</th>
                            <th>Success</th>
                            <th>Improved</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in recent_logs %}
                        <tr>
                            <td>{{ log.name }}</td>
                            <td>{{ log.started_at|date:"Y-m-d H:i" }}</td>
                            <td>
                                <span class="badge bg-{{ log.get_status_color }}">
                                    {{ log.get_status_display }}
                                </span>
                            </td>
                            <td>{{ log.total_meters }}</td>
                            <td>
                                {% if log.success_count > 0 %}
                                <span class="text-success">{{ log.success_count }}</span>
                                {% else %}
                                <span class="text-danger">{{ log.success_count }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.improved_count > 0 %}
                                <span class="text-success">{{ log.improved_count }}</span>
                                {% else %}
                                <span class="text-warning">{{ log.improved_count }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.duration_seconds %}
                                    {% widthratio log.duration_seconds 60 1 as minutes %}
                                    {{ minutes|floatformat:1 }} min
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'admin:core_retraininglog_change' log.id %}" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-search"></i> View
                                </a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                <i class="fas fa-info-circle me-2"></i>
                                No retraining logs found.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
// Show/hide meter selection based on scope
document.getElementById('scopeSelect').addEventListener('change', function() {
    const meterSelection = document.getElementById('meterSelection');
    if (this.value === 'selected') {
        meterSelection.style.display = 'block';
    } else {
        meterSelection.style.display = 'none';
    }
});

function showPreview() {
    const scope = document.getElementById('scopeSelect').value;
    let meterCount = 0;
    
    if (scope === 'needing') {
        meterCount = {{ meters_needing|length }};
        alert(`Preview: Will retrain ${meterCount} meters that need retraining.`);
    } else if (scope === 'all') {
        meterCount = {{ system_health.meters_with_models }};
        alert(`Preview: Will retrain all ${meterCount} meters with models.`);
    } else if (scope === 'selected') {
        const selected = document.querySelectorAll('input[name="selected_meters"]:checked').length;
        alert(`Preview: Will retrain ${selected} selected meters.`);
    }
}

function startRetraining(event) {
    event.preventDefault();
    
    if (!confirm('Start adaptive retraining? This may take several minutes.')) {
        return;
    }
    
    // In a real implementation, this would submit the form
    // For now, show a message
    alert('Retraining job has been scheduled. Check retraining logs for progress.');
    
    // Redirect to retraining logs
    window.location.href = "{% url 'admin:core_retraininglog_changelist' %}";
}

function retrainSingleMeter(meterId) {
    if (confirm(`Retrain model for meter ${meterId}?`)) {
        // In a real implementation, this would trigger a single-meter retraining
        alert(`Retraining scheduled for ${meterId}. Check retraining logs for progress.`);
        
        // Redirect to retraining logs
        window.location.href = "{% url 'admin:core_retraininglog_changelist' %}";
    }
}

function refreshData() {
    window.location.reload();
}
</script>
{% endblock %}